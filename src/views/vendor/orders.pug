extends ../layout

block content
  - const isDriver = currentUser && currentUser.role === 'driver';
  - const isVendor = currentUser && currentUser.role === 'vendor';

  .vendor-dashboard-header
    .row.align-items-center.g-3
      .col-lg-7
        .d-flex.align-items-center.gap-3  
          .header-icon-box
            i.bi.bi-box-seam
          div
            .dashboard-title= isDriver ? "Pesanan Untuk Dikirim" : "Pesanan Saya"
            .dashboard-subtitle
              i.bi.bi-truck.me-2
              | Kelola dan lacak pesanan produk Anda
      
      .col-lg-5.text-lg-end
        .action-buttons
          if isVendor
            a.btn-action.btn-outline-action(href='/vendor/dashboard')
              i.bi.bi-arrow-left
              span Kembali ke Dashboard
          if isDriver
            a.btn-action.btn-outline-action(href='/market ')
              i.bi.bi-arrow-left
              span Kembali

  .container-fluid
    if flash && flash.success
      .alert.alert-success.alert-dismissible.fade.show.shadow-sm(role='alert')
        .d-flex.align-items-center
          .alert-icon.me-3
            i.bi.bi-check-circle-fill
          .flex-grow-1 #{flash.success}
        button.btn-close(type='button' data-bs-dismiss='alert')

    if flash && flash.error
      .alert.alert-danger.alert-dismissible.fade.show.shadow-sm(role='alert')
        .d-flex.align-items-center
          .alert-icon.me-3
            i.bi.bi-exclamation-triangle-fill
          .flex-grow-1 #{flash.error}
        button.btn-close(type='button' data-bs-dismiss='alert')

    if orders && orders.length
      .row.g-4.mt-2
        each o, index in orders
          .col-lg-4.col-md-6(style=`animation-delay:${0.05 * index}s`)
            .order-card-compact.shadow-sm.h-100
              
              .card-compact-header
                .d-flex.justify-content-between.align-items-start.mb-2
                  .order-id-compact
                    i.bi.bi-hash
                    span= o.order_id

                  - // determine visual status: prefer order_status (completed) else vendor_status
                  - var visualStatus = o.order_status === 'completed' ? 'completed' : o.vendor_status;
                  - var statusClass = visualStatus === 'shipped' || visualStatus === 'completed' ? 'success' : 'warning';
                  .status-pill-compact(class=`status-${statusClass}`)
                    // icon: check-circle for completed, truck for shipped, clock-history otherwise
                    if o.order_status === 'completed'
                      i.bi.bi-check-circle-fill
                    else
                      i.bi(class=`bi-${o.vendor_status === 'shipped' ? 'truck' : 'clock-history'}`)

                .order-date-compact
                  i.bi.bi-calendar3.me-1
                  span= o.created_at

              .card-compact-body
                .total-compact.mb-3
                  .total-label-compact Total
                  .total-value-compact Rp #{o.order_total.toLocaleString('id-ID')}

                // â”€â”€ NEW: Info Dapur (pembeli)
                .dapur-info.mb-3
                  small.text-muted.mb-1 Dari:
                  .dapur-card
                    .d-flex.justify-content-between
                      .dapur-left
                        strong= o.dapur_name || '-'
                        br
                        small.text-muted #{o.dapur_address ? (o.dapur_address.length > 80 ? o.dapur_address.substring(0,80) + '...' : o.dapur_address) : '-'}
                      .dapur-right.text-end
                        small.text-muted No. Telp
                        br
                        if o.dapur_phone
                          small.text-muted #{o.dapur_phone}
                        else
                          span.text-muted -
                  hr

                .items-compact
                  .items-title
                    i.bi.bi-box.me-1
                    span #{o.items.length} Item
                  each it in o.items
                    .item-compact
                      .item-name-compact
                        i.bi.bi-circle-fill.me-2
                        span= it.product_name
                      - var qtyInt = parseInt(it.qty, 10) || 0
                      .item-qty-compact #{qtyInt}x
              .card-compact-footer
                // if order already completed â€” show final label and disable all actions
                if o.order_status === 'completed'
                  .completed-compact
                    i.bi.bi-check-circle-fill.me-2
                    | Pesanan Selesai
                else
                  // ============================
                  //      MODE VENDOR
                  // ============================
                  if isVendor
                    - const disableVendor = (o.vendor_status === 'preparing' || o.vendor_status === 'shipped');

                    if o.vendor_status === 'shipped'
                      // jika sudah ada konfirmasi penerimaan, tunjukkan "Supir telah sampai"
                      if o.delivery_confirmed
                        .completed-compact
                          i.bi.bi-truck.me-2
                          | Dapur sudah TTD
                      else
                        .completed-compact
                          i.bi.bi-truck.me-2
                          | Dikirim oleh Supir
                    else
                      form.vendor-status-form(method="post" action=`/vendor/orders/${o.order_id}/status`)
                        select.form-select.form-select-sm.mb-2(name="status" disabled=disableVendor)
                          option(value="preparing" selected=(o.vendor_status==='preparing')) ðŸ“¦ Siapkan
                        button.btn.btn-primary.btn-sm.w-100(type="submit" disabled=disableVendor)
                          i.bi.bi-arrow-repeat.me-1
                          | Update

                  // ============================
                  //      MODE DRIVER
                  // ============================
                  if isDriver
                    if o.vendor_status !== 'preparing'
                      // shipped state: allow edit once if tracking_number not set and dapur belum konfirmasi
                      if o.vendor_status === 'shipped'
                        if !o.tracking_number && !o.delivery_confirmed
                          button.btn.btn-outline-success.btn-sm.w-100.btn-open-signature(
                            type="button"
                            data-order-id=o.order_id
                            data-order-number=o.order_id
                            data-dapur-name=o.dapur_name || 'Dapur'
                          )
                            i.bi.bi-pen.me-1
                            | Edit Surat Jalan
                        else
                          button.btn.btn-outline-secondary.btn-sm.w-100(disabled)
                            i.bi.bi-lock.me-1
                            | Surat Jalan Sudah Dikirim
                    else
                      button.btn.btn-primary.btn-sm.w-100.btn-open-ship(
                        type="button"
                        data-order-id=o.order_id
                      )
                        i.bi.bi-send-check.me-2
                        | Kirim Pesanan

    else
      .empty-state
        .empty-card
          .empty-icon
            i.bi.bi-inbox
          .empty-title Tidak Ada Pesanan
          .empty-text Pesanan kosong untuk saat ini.

  // ============================
  //   MODAL SURAT JALAN (DRIVER)
  // ============================
  .modal.fade#deliveryNoteModal(tabindex='-1' aria-hidden='true')
    .modal-dialog.modal-lg.modal-dialog-scrollable
      .modal-content.border-0
        .modal-header.border-0.pb-2
          h5.modal-title.fw-bold#deliveryNoteTitle
            i.bi.bi-file-earmark-text.me-2(style='color: #28a745;')
            | Surat Jalan Pengiriman
          button.btn-close(type='button' data-bs-dismiss='modal')
        
        form#deliveryNoteForm(method='post' enctype='multipart/form-data')
          .modal-body.p-4
            input(type='hidden' name='order_id' id='dn-order-id')
            
            .form-section.mb-4
              .section-header.mb-3
                i.bi.bi-truck.me-2(style='color: #28a745;')
                h6.fw-bold.mb-0.d-inline Informasi Pengiriman
              .section-body
                .row.g-3
                  .col-md-6
                    label.form-label
                      i.bi.bi-calendar-event.me-2
                      | Tanggal & Waktu
                    input.form-control.form-control-lg(type='datetime-local' name='shipped_at' id='dn-shipped-at' required)
                  .col-md-6
                    label.form-label
                      i.bi.bi-car-front.me-2
                      | No. Plat Kendaraan
                    input.form-control.form-control-lg(type='text' name='plate_number' id='dn-plate' placeholder='B 1234 ABC' required)

            .form-section.mb-4
              .section-header.mb-3
                i.bi.bi-person-badge.me-2(style='color: #28a745;')
                h6.fw-bold.mb-0.d-inline Data Pengirim
              .section-body
                .row.g-3
                  .col-md-6
                    label.form-label
                      i.bi.bi-person.me-2
                      | Nama Pengirim
                    input.form-control.form-control-lg(type='text' name='sender_name' id='dn-sender-name' required)
                  .col-md-6
                    label.form-label
                      i.bi.bi-phone.me-2
                      | Kontak Pengirim
                    input.form-control.form-control-lg(type='text' name='sender_contact' id='dn-sender-contact' placeholder='0812xxxx' required)

            .form-section.mb-4
              .section-header.mb-3
                i.bi.bi-paperclip.me-2(style='color: #28a745;')
                h6.fw-bold.mb-0.d-inline Catatan & Foto Bukti
              .section-body
                .mb-3
                  label.form-label
                    i.bi.bi-chat-left-text.me-2
                    | Catatan
                    span.text-muted.small  (opsional)
                  textarea.form-control(name='note' id='dn-note' rows='3' placeholder='Tambahkan catatan pengiriman...')
                
                .mb-0
                  label.form-label
                    i.bi.bi-file-earmark-arrow-up.me-2
                    | Foto Bukti
                    span.text-danger  *
                  input.form-control.form-control-lg(
                    type='file'
                    name='delivery_attachment'
                    id='dn-attachment'
                    accept='image/*,.pdf'
                    capture='environment'
                    required
                  )
                  .form-text
                    i.bi.bi-info-circle.me-1
                    | Format: JPG, PNG, atau PDF (Max 5MB)

            .form-section.mb-0
              .section-header.mb-3
                i.bi.bi-pen.me-2(style='color: #28a745;')
                h6.fw-bold.mb-0.d-inline Tanda Tangan Pengirim
              .section-body
                .signature-area
                  canvas#signature-pad
                .signature-controls
                  .text-muted.small
                    i.bi.bi-hand-index.me-1
                    | Tanda tangan di area putih di atas
                  button.btn.btn-outline-danger.btn-sm(type='button' id='dn-clear-signature')
                    i.bi.bi-eraser.me-2
                    | Hapus Tanda Tangan
                input(type='hidden' name='signature_data' id='dn-signature-data')

          .modal-footer.border-0.bg-light
            button.btn.btn-lg.btn-outline-secondary(type='button' data-bs-dismiss='modal')
              i.bi.bi-x-circle.me-2
              | Batal
            button.btn.btn-lg.px-5(type='submit' style='background: #28a745; color: white; border: none;')
              i.bi.bi-send-check.me-2
              | Kirim Surat Jalan

  // ============================
  //   MODAL TANDA TANGAN DAPUR (DRIVER)
  // ============================
  .modal.fade#deliverySignatureModal(tabindex='-1' aria-hidden='true')
    .modal-dialog.modal-lg.modal-dialog-scrollable
      .modal-content.border-0
        .modal-header.border-0.pb-2
          h5.modal-title.fw-bold#deliverySignatureTitle
            i.bi.bi-pen.me-2(style='color: #28a745;')
            | Tanda Tangan Dapur
          button.btn-close(type='button' data-bs-dismiss='modal')
        
        form#deliverySignatureForm(method='post' enctype='multipart/form-data')
          .modal-body.p-4
            input(type='hidden' name='order_id' id='ds-order-id')
            
            .form-section.mb-4
              .section-header.mb-3
                i.bi.bi-clock.me-2(style='color: #28a745;')
                h6.fw-bold.mb-0.d-inline Waktu Penerimaan
              .section-body
                .row.g-3
                  .col-md-6
                    label.form-label
                      i.bi.bi-calendar-event.me-2
                      | Tanggal & Waktu
                    input.form-control.form-control-lg(type='datetime-local' name='arrived_at' id='ds-arrived-at' required)
                  .col-md-6
                    label.form-label
                      i.bi.bi-person-badge.me-2
                      | Nama Penerima
                    input.form-control.form-control-lg(type='text' name='receiver_name' id='ds-receiver-name' placeholder='Nama pihak dapur' required)

            .form-section.mb-4
              .section-header.mb-3
                i.bi.bi-chat-left-text.me-2(style='color: #28a745;')
                h6.fw-bold.mb-0.d-inline Catatan (Opsional)
              .section-body
                textarea.form-control(name='notes' id='ds-notes' rows='3' placeholder='Catatan untuk yayasan...')

            .row.g-4
              // Kolom Kiri: Foto Bukti
              .col-md-6
                .form-section.h-100
                  .section-header.mb-3
                    i.bi.bi-camera.me-2(style='color: #28a745;')
                    h6.fw-bold.mb-0.d-inline Foto Bukti
                      span.text-danger  *
                  .section-body
                    .mb-3
                      input.form-control.form-control-lg(
                        type='file'
                        name='proof_file'
                        id='ds-proof-file'
                        accept='image/*'
                        capture='environment'
                        required
                      )
                      .form-text
                        i.bi.bi-info-circle.me-1
                        | Ambil foto dari kamera atau upload dari galeri
                    
                    .preview-container.mt-3.text-center
                      img#ds-proof-preview(
                        src=''
                        alt='Preview foto bukti'
                        style='width:100%; max-height:260px; object-fit:cover; border:2px dashed #e5e7eb; border-radius:12px; display:none;'
                      )
                      small#ds-no-preview.text-muted(style='display:block;')
                        i.bi.bi-image.me-1
                        | Preview akan muncul setelah memilih file

              // Kolom Kanan: Tanda Tangan
              .col-md-6
                .form-section.h-100
                  .section-header.mb-3
                    i.bi.bi-pen.me-2(style='color: #28a745;')
                    h6.fw-bold.mb-0.d-inline Tanda Tangan
                      span.text-danger  *
                  .section-body
                    .signature-area-small
                      canvas#ds-signature-pad(style='width:100%; height:200px;')
                    .signature-controls
                      .text-muted.small.mb-2
                        i.bi.bi-hand-index.me-1
                        | Minta pihak dapur menandatangani di area ini
                      button.btn.btn-outline-danger.btn-sm(type='button' id='ds-clear-signature')
                        i.bi.bi-eraser.me-2
                        | Hapus Tanda Tangan
                    input(type='hidden' name='signature_data' id='ds-signature-data')

          .modal-footer.border-0.bg-light
            button.btn.btn-lg.btn-outline-secondary(type='button' data-bs-dismiss='modal')
              i.bi.bi-x-circle.me-2
              | Batal
            button.btn.btn-lg.px-5(type='submit' style='background: #28a745; color: white; border: none;')
              i.bi.bi-save.me-2
              | Simpan Surat Jalan

  //- CSS
  style.
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    .vendor-dashboard-header {
      background: #ffffff;
      padding: 40px 0;
      margin-bottom: 40px;
      border-bottom: 1px solid #e8e8e8;
      animation: fadeInUp 0.6s ease-out;
    }
    .header-icon-box {
      width: 64px;
      height: 64px;
      background: #f8f9fa;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      color: #28a745;
      border: 1px solid #e8e8e8;
      transition: all 0.4s ease;
      flex-shrink: 0;
    }
    .header-icon-box:hover {
      background: #28a745;
      color: white;
      transform: rotate(10deg) scale(1.1);
      border-color: #28a745;
    }
    .dashboard-title {
      font-size: 2rem;
      color: #2c3e50;
      font-weight: 700;
      margin-bottom: 6px;
      letter-spacing: -0.5px;
    }
    .dashboard-subtitle {
      color: #6c757d;
      font-size: 1rem;
      margin: 0;
    }
    .action-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .btn-action {
      padding: 14px 24px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 1rem;
      border: none;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      position: relative;
    }
    .btn-action:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }
    .btn-outline-action {
      background: white;
      color: #6c757d;
      border: 2px solid #e8e8e8;
    }
    .btn-outline-action:hover {
      background: #fafafa;
      border-color: #28a745;
      color: #28a745;
    }
    .stats-row { margin-bottom: 40px; }
    .stat-card {
      background: #ffffff;
      border: 1px solid #e8e8e8;
      border-radius: 16px;
      padding: 28px;
      transition: all 0.4s ease;
      position: relative;
      overflow: hidden;
      animation: fadeInUp 0.6s ease-out;
      cursor: pointer;
    }
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: #28a745;
      transform: scaleX(0);
      transition: transform 0.4s ease;
    }
    .stat-card:hover::before { transform: scaleX(1); }
    .stat-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 12px 28px rgba(40, 167, 69, 0.12);
      border-color: #28a745;
    }
    .stat-icon-wrapper {
      width: 64px;
      height: 64px;
      background: #f0f9f3;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      color: #28a745;
      margin-bottom: 20px;
      border: 1px solid #e8e8e8;
      transition: all 0.3s ease;
    }
    .stat-card:hover .stat-icon-wrapper {
      background: #28a745;
      color: white;
      transform: rotate(5deg) scale(1.05);
      border-color: #28a745;
    }
    .stat-label {
      color: #6c757d;
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
    }
    .stat-value {
      font-size: 2.2rem;
      font-weight: 700;
      color: #2c3e50;
      line-height: 1;
    }
    .stat-description {
      color: #6c757d;
      font-size: 0.85rem;
      margin-top: 8px;
    }
    .order-card-compact {
      background: white;
      border: 1px solid #e8e8e8;
      border-radius: 16px;
      overflow: hidden;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      animation: fadeInUp 0.6s ease-out;
    }
    .order-card-compact:hover {
      transform: translateY(-6px);
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.08);
      border-color: #28a745;
    }
    .card-compact-header {
      background: #f8f9fa;
      padding: 16px;
      border-bottom: 1px solid #e8e8e8;
    }
    .order-id-compact {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: #28a745;
      color: white;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 700;
    }
    .status-pill-compact {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
    }
    .status-pill-compact.status-success {
      background: #f0f9f3;
      color: #28a745;
      border: 1px solid #e8e8e8;
    }
    .status-pill-compact.status-warning {
      background: #fff8f0;
      color: #ffc107;
      border: 1px solid #e8e8e8;
    }
    .order-date-compact {
      color: #6b7280;
      font-size: 0.8rem;
      margin-top: 8px;
    }
    .card-compact-body { padding: 16px; flex: 1; }
    .total-compact {
      background: #f0f9f3;
      border: 1px solid #e8e8e8;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }
    .total-label-compact {
      color: #6c757d;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }
    .total-value-compact {
      color: #28a745;
      font-size: 1.5rem;
      font-weight: 700;
      line-height: 1;
    }
    .items-compact { margin-top: 16px; }
    .items-title {
      color: #6c757d;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e8e8e8;
    }
    .item-compact {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      font-size: 0.85rem;
      border-bottom: 1px solid #f8f9fa;
    }
    .item-compact:last-child { border-bottom: none; }
    .item-name-compact {
      display: flex;
      align-items: center;
      flex: 1;
      color: #374151;
    }
    .item-name-compact i {
      font-size: 0.4rem;
      color: #28a745;
    }
    .item-qty-compact {
      background: #f3f4f6;
      color: #374151;
      padding: 4px 10px;
      border-radius: 6px;
      font-weight: 600;
      font-size: 0.8rem;
    }
    .card-compact-footer {
      padding: 16px;
      background: #fafafa;
      border-top: 1px solid #e8e8e8;
    }
    .completed-compact {
      background: #f0f9f3;
      color: #28a745;
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.85rem;
      text-align: center;
      border: 1px solid #e8e8e8;
    }
    .card-compact-footer .form-select {
      border: 1px solid #e8e8e8;
      border-radius: 8px;
      font-size: 0.85rem;
    }
    .card-compact-footer .form-select:focus {
      border-color: #28a745;
      box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
    }
    .card-compact-footer .btn {
      font-size: 0.85rem;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    .card-compact-footer .btn:hover { transform: translateY(-1px); }
    .card-compact-footer .btn-primary {
      background: #28a745;
      border: none;
    }
    .card-compact-footer .btn-primary:hover { background: #218838; }
    .card-compact-footer .btn-outline-success {
      border: 2px solid #28a745;
      color: #28a745;
    }
    .card-compact-footer .btn-outline-success:hover {
      background: #28a745;
      color: white;
    }
    .empty-state { padding: 80px 20px; }
    .empty-card {
      max-width: 600px;
      margin: 0 auto;
      text-align: center;
      background: white;
      border: 1px solid #e8e8e8;
      border-radius: 20px;
      padding: 60px 40px;
      animation: fadeInUp 0.6s ease-out;
    }
    .empty-icon {
      font-size: 120px;
      color: #e8e8e8;
      margin-bottom: 24px;
      animation: float 3s ease-in-out infinite;
    }
    .empty-title {
      color: #2c3e50;
      font-weight: 700;
      font-size: 1.8rem;
      margin-bottom: 12px;
    }
    .empty-text {
      color: #6c757d;
      font-size: 1.1rem;
      margin-bottom: 0;
    }
    .empty-card .btn-action {
      padding: 16px 32px;
      font-size: 1.1rem;
      margin-top: 24px;
    }
    .btn-primary-action {
      background: #28a745;
      color: white;
    }
    .btn-primary-action:hover { background: #218838; }
    .modal-content {
      border-radius: 24px;
      max-height: 90vh;
    }
    .modal-body {
      max-height: calc(90vh - 180px);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .form-section {
      background: #f8f9fa;
      border-radius: 16px;
      padding: 20px;
    }
    .section-header {
      color: #374151;
      margin-bottom: 16px;
    }
    .form-control, .form-select {
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      padding: 12px 16px;
    }
    .form-control:focus, .form-select:focus {
      border-color: #28a745;
      box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
    }
    .form-label {
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
    }
    .signature-area {
      background: white;
      border: 3px dashed #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }
    #signature-pad {
      width: 100%;
      height: 200px;
      cursor: crosshair;
      background: white;
      border-radius: 8px;
      display: block;
    }
    .signature-area-small {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      height: 240px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #ds-signature-pad {
      width: 100%;
      height: 100%;
      border-radius: 8px;
      background: white;
      cursor: crosshair;
    }
    .preview-container {
      min-height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f8f9fa;
      border-radius: 12px;
      border: 2px dashed #e5e7eb;
      transition: all 0.3s ease;
    }
    .preview-container:hover {
      border-color: #28a745;
      background: #f0f9f3;
    }
    #ds-proof-preview {
      transition: all 0.3s ease;
    }
    #ds-no-preview {
      padding: 40px;
    }
    .form-section.h-100 {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .form-section.h-100 .section-body {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .signature-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .alert-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      flex-shrink: 0;
    }
    .alert-success {
      background: #f0f9f3;
      border: 1px solid #e8e8e8;
      color: #2c3e50;
    }
    .alert-success .alert-icon {
      background: rgba(40, 167, 69, 0.15);
      color: #28a745;
    }
    .alert-danger {
      background: #fff5f5;
      border: 1px solid #e8e8e8;
      color: #2c3e50;
    }
    .alert-danger .alert-icon {
      background: rgba(220, 53, 69, 0.15);
      color: #dc3545;
    }
    @media (max-width: 768px) {
      .vendor-dashboard-header {
        padding: 30px 0;
      }
      .dashboard-title {
        font-size: 1.6rem;
      }
      .header-icon-box {
        width: 56px;
        height: 56px;
        font-size: 24px;
      }
      .stat-card {
        padding: 24px;
      }
      .stat-value {
        font-size: 1.8rem;
      }
      .order-card-compact {
        margin-bottom: 16px;
      }
      .total-value-compact {
        font-size: 1.3rem;
      }
      .signature-area-small {
        height: 180px;
      }
      #ds-proof-preview {
        max-height: 180px;
      }
      .preview-container {
        min-height: 150px;
      }
      .modal-dialog {
        margin: 10px;
      }
      .modal-body {
        padding: 16px;
      }
    }
    @media (max-width: 992px) {
      .action-buttons {
        width: 100%;
      }
      .btn-action {
        flex: 1;
        justify-content: center;
      }
    }

  //- JS: untuk modal surat jalan dan tanda tangan dapur
  script.
    (function(){
      var isDriver = !{JSON.stringify(!!(currentUser && currentUser.role === 'driver'))};
      var isVendor = !{JSON.stringify(!!(currentUser && currentUser.role === 'vendor'))};

      document.addEventListener('DOMContentLoaded', function(){
        if (!isDriver) return;
        var deliveryModalEl = document.getElementById('deliveryNoteModal');
        if (deliveryModalEl) {
          var deliveryModal = new bootstrap.Modal(deliveryModalEl, { backdrop: true });
          var dnForm = document.getElementById('deliveryNoteForm');
          var dnOrderId = document.getElementById('dn-order-id');
          var dnShippedAt = document.getElementById('dn-shipped-at');
          var dnTitle = document.getElementById('deliveryNoteTitle');

          var sigCanvas = document.getElementById('signature-pad');
          var sigInput = document.getElementById('dn-signature-data');
          var sigClearBtn = document.getElementById('dn-clear-signature');
          var sigCtx = sigCanvas ? sigCanvas.getContext('2d') : null;
          var drawing = false;
          var hasDrawn = false;
          var lastPos = { x: 0, y: 0 };

          function resizeSignatureCanvas(){
            if (!sigCanvas || !sigCtx) return;
            var rect = sigCanvas.getBoundingClientRect();
            if (!rect.width || !rect.height) return;
            sigCanvas.width = rect.width;
            sigCanvas.height = rect.height;
            sigCtx.lineWidth = 2;
                        sigCtx.lineCap = 'round';
            sigCtx.strokeStyle = '#000';
            sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
            hasDrawn = false;
            if (sigInput) sigInput.value = '';
          }

          function getPos(e){
            var rect = sigCanvas.getBoundingClientRect();
            return {
              x: e.clientX - rect.left,
              y: e.clientY - rect.top
            };
          }

          function startDraw(e){
            if (!sigCanvas || !sigCtx) return;
            e.preventDefault();
            e.stopPropagation();
            drawing = true;
            hasDrawn = true;
            lastPos = getPos(e);
          }

          function draw(e){
            if (!drawing || !sigCanvas || !sigCtx) return;
            e.preventDefault();
            e.stopPropagation();
            var pos = getPos(e);
            sigCtx.beginPath();
            sigCtx.moveTo(lastPos.x, lastPos.y);
            sigCtx.lineTo(pos.x, pos.y);
            sigCtx.stroke();
            lastPos = pos;
          }

          function endDraw(e){
            if (!drawing) return;
            e.stopPropagation();
            drawing = false;
          }

          if (sigCanvas && sigCtx) {
            deliveryModalEl.addEventListener('shown.bs.modal', function(){
              resizeSignatureCanvas();
            });
            window.addEventListener('resize', function(){
              resizeSignatureCanvas();
            });
            sigCanvas.addEventListener('pointerdown', startDraw);
            sigCanvas.addEventListener('pointermove', draw);
            sigCanvas.addEventListener('pointerup', endDraw);
            sigCanvas.addEventListener('pointerleave', endDraw);
            if (sigClearBtn) {
              sigClearBtn.addEventListener('click', function(){
                sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
                hasDrawn = false;
                if (sigInput) sigInput.value = '';
              });
            }
          }

          function nowLocalInputValue() {
            var d = new Date();
            var pad = function(n){ return n.toString().padStart(2,'0'); };
            var yyyy = d.getFullYear();
            var mm = pad(d.getMonth()+1);
            var dd = pad(d.getDate());
            var hh = pad(d.getHours());
            var mi = pad(d.getMinutes());
            return yyyy + '-' + mm + '-' + dd + 'T' + hh + ':' + mi;
          }

          // tombol Kirim Pesanan (driver)
          document.querySelectorAll('.btn-open-ship').forEach(function(btn){
            btn.addEventListener('click', function(){
              var orderId = btn.getAttribute('data-order-id');
              dnOrderId.value = orderId;
              dnShippedAt.value = nowLocalInputValue();
              dnTitle.innerHTML = '<i class="bi bi-file-earmark-text me-2" style="color: #28a745;"></i>Surat Jalan â€” Order #' + orderId;
              if (sigCanvas && sigCtx) {
                sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
                hasDrawn = false;
                if (sigInput) sigInput.value = '';
              }
              deliveryModal.show();
            });
          });

          dnForm.addEventListener('submit', function(ev){
            ev.preventDefault();
            if (sigCanvas && sigInput) {
              if (!hasDrawn) {
                alert('Mohon isi tanda tangan pengirim terlebih dahulu.');
                return;
              }
              try {
                sigInput.value = sigCanvas.toDataURL('image/png');
              } catch (e) {
                console.error('toDataURL error:', e);
                alert('Gagal mengambil tanda tangan. Coba lagi.');
                return;
              }
            }
            var fd = new FormData(dnForm);
            var orderId = fd.get('order_id');
            var submitBtn = dnForm.querySelector('button[type="submit"]');
            var originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Mengirim...';
            fetch('/driver/orders/' + encodeURIComponent(orderId) + '/ship', {
              method: 'POST',
              body: fd
            })
            .then(function(resp){
              if (!resp.ok) {
                return resp.text().then(function(t){
                  throw new Error(t || 'Server error');
                });
              }

              // âœ… sukses, ga usah parse JSON
              deliveryModal.hide();
              location.reload();
            })
            .catch(function(err){
              alert('Gagal submit surat jalan: ' + (err.message || err));
              submitBtn.disabled = false;
              submitBtn.innerHTML = originalText;
            });
          });
        }

        // ============================
        //  MODAL TANDA TANGAN DAPUR
        // ============================
        var signatureModalEl = document.getElementById('deliverySignatureModal');
        if (signatureModalEl) {
          var signatureModal = new bootstrap.Modal(signatureModalEl, { backdrop: true });
          var signatureForm = document.getElementById('deliverySignatureForm');
          var dsOrderId = document.getElementById('ds-order-id');
          var dsArrivedAt = document.getElementById('ds-arrived-at');
          var dsReceiverName = document.getElementById('ds-receiver-name');
          var dsTitle = document.getElementById('deliverySignatureTitle');

          // Elements untuk signature
          var dsSigCanvas = document.getElementById('ds-signature-pad');
          var dsSigInput = document.getElementById('ds-signature-data');
          var dsSigClearBtn = document.getElementById('ds-clear-signature');
          var dsSigCtx = dsSigCanvas ? dsSigCanvas.getContext('2d') : null;
          var dsDrawing = false;
          var dsHasDrawn = false;
          var dsLastPos = { x: 0, y: 0 };

          // Elements untuk file preview
          var dsProofFile = document.getElementById('ds-proof-file');
          var dsProofPreview = document.getElementById('ds-proof-preview');
          var dsNoPreview = document.getElementById('ds-no-preview');

          // Fungsi resize canvas signature
          function resizeDsSignatureCanvas() {
            if (!dsSigCanvas || !dsSigCtx) return;
            var rect = dsSigCanvas.getBoundingClientRect();
            if (!rect.width || !rect.height) return;
            dsSigCanvas.width = rect.width;
            dsSigCanvas.height = rect.height;
            dsSigCtx.lineWidth = 2;
            dsSigCtx.lineCap = 'round';
            dsSigCtx.strokeStyle = '#000';
            dsSigCtx.clearRect(0, 0, dsSigCanvas.width, dsSigCanvas.height);
            dsHasDrawn = false;
            if (dsSigInput) dsSigInput.value = '';
          }

          // Fungsi get position untuk signature
          function getDsPos(e) {
            var rect = dsSigCanvas.getBoundingClientRect();
            return {
              x: e.clientX - rect.left,
              y: e.clientY - rect.top
            };
          }

          // Event handlers untuk signature
          function startDsDraw(e) {
            if (!dsSigCanvas || !dsSigCtx) return;
            e.preventDefault();
            e.stopPropagation();
            dsDrawing = true;
            dsHasDrawn = true;
            dsLastPos = getDsPos(e);
          }

          function drawDs(e) {
            if (!dsDrawing || !dsSigCanvas || !dsSigCtx) return;
            e.preventDefault();
            e.stopPropagation();
            var pos = getDsPos(e);
            dsSigCtx.beginPath();
            dsSigCtx.moveTo(dsLastPos.x, dsLastPos.y);
            dsSigCtx.lineTo(pos.x, pos.y);
            dsSigCtx.stroke();
            dsLastPos = pos;
          }

          function endDsDraw(e) {
            if (!dsDrawing) return;
            e.stopPropagation();
            dsDrawing = false;
          }

          // Setup signature canvas
          if (dsSigCanvas && dsSigCtx) {
            signatureModalEl.addEventListener('shown.bs.modal', function() {
              resizeDsSignatureCanvas();
            });
            
            window.addEventListener('resize', resizeDsSignatureCanvas);
            
            dsSigCanvas.addEventListener('pointerdown', startDsDraw);
            dsSigCanvas.addEventListener('pointermove', drawDs);
            dsSigCanvas.addEventListener('pointerup', endDsDraw);
            dsSigCanvas.addEventListener('pointerleave', endDsDraw);
            
            if (dsSigClearBtn) {
              dsSigClearBtn.addEventListener('click', function() {
                dsSigCtx.clearRect(0, 0, dsSigCanvas.width, dsSigCanvas.height);
                dsHasDrawn = false;
                if (dsSigInput) dsSigInput.value = '';
              });
            }
          }

          // Preview foto bukti
          if (dsProofFile && dsProofPreview && dsNoPreview) {
            dsProofFile.addEventListener('change', function() {
              var file = dsProofFile.files && dsProofFile.files[0];
              if (!file) {
                dsProofPreview.style.display = 'none';
                dsNoPreview.style.display = 'block';
                dsProofPreview.src = '';
                return;
              }
              
              var reader = new FileReader();
              reader.onload = function(e) {
                dsProofPreview.src = e.target.result;
                dsProofPreview.style.display = 'block';
                dsNoPreview.style.display = 'none';
              };
              reader.readAsDataURL(file);
            });
          }

          // Fungsi untuk waktu sekarang
          function nowLocalInputValue() {
            var d = new Date();
            var pad = function(n) { return n.toString().padStart(2, '0'); };
            var yyyy = d.getFullYear();
            var mm = pad(d.getMonth() + 1);
            var dd = pad(d.getDate());
            var hh = pad(d.getHours());
            var mi = pad(d.getMinutes());
            return yyyy + '-' + mm + '-' + dd + 'T' + hh + ':' + mi;
          }

          // Tombol TTD Dapur di order card
          document.querySelectorAll('.btn-open-signature').forEach(function(btn) {
            btn.addEventListener('click', function() {
              var orderId = btn.getAttribute('data-order-id');
              var orderNumber = btn.getAttribute('data-order-number');
              var dapurName = btn.getAttribute('data-dapur-name');
              
              dsOrderId.value = orderId;
              dsArrivedAt.value = nowLocalInputValue();
              dsReceiverName.value = '';
              dsTitle.innerHTML = '<i class="bi bi-pen me-2" style="color: #28a745;"></i>Tanda Tangan Dapur â€” Order #' + orderNumber;
              
              // Reset signature
              if (dsSigCanvas && dsSigCtx) {
                resizeDsSignatureCanvas();
              }
              
              // Reset file preview
              if (dsProofFile && dsProofPreview && dsNoPreview) {
                dsProofFile.value = '';
                dsProofPreview.style.display = 'none';
                dsProofPreview.src = '';
                dsNoPreview.style.display = 'block';
              }
              
              // Show modal
              signatureModal.show();
            });
          });

          // Handle form submission
          signatureForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Validasi signature
            if (!dsHasDrawn) {
              alert('Mohon minta pihak dapur menandatangani terlebih dahulu.');
              return;
            }
            
            // Validasi file
            if (!dsProofFile.files || dsProofFile.files.length === 0) {
              alert('Harap upload foto bukti penerimaan.');
              return;
            }
            
            // Convert signature to data URL
            if (dsSigCanvas && dsSigCtx) {
              try {
                var sigDataUrl = dsSigCanvas.toDataURL('image/png');
                dsSigInput.value = sigDataUrl;
              } catch (error) {
                console.error('Error converting signature:', error);
                alert('Gagal mengambil tanda tangan. Coba lagi.');
                return;
              }
            }
            
            // Submit form via AJAX
            var formData = new FormData(signatureForm);
            var orderId = formData.get('order_id');
            
            var submitBtn = signatureForm.querySelector('button[type="submit"]');
            var originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Menyimpan...';
            
            // Tentukan endpoint (gunakan endpoint driver untuk TTD dapur)
            var endpoint = '/driver/orders/' + encodeURIComponent(orderId) + '/sign';
            
            fetch(endpoint, {
              method: 'POST',
              body: formData
            })
            .then(function(response) {
              if (!response.ok) {
                return response.text().then(function(text) {
                  throw new Error(text || 'Server error');
                });
              }

              // âœ… sukses, langsung reload
              alert('Surat jalan berhasil disimpan!');
              signatureModal.hide();
              location.reload();
            })
            .catch(function(error) {
              console.error('Error:', error);
              alert('Terjadi kesalahan: ' + (error.message || error));
              submitBtn.disabled = false;
              submitBtn.innerHTML = originalText;
            });
          });
        }
        // ============================
        //  VENDOR ORDER ACTIONS
        // ============================
        var isVendor = !{JSON.stringify(!!(currentUser && currentUser.role === 'vendor'))};
        if (isVendor) {
          // Process Order (update status)
          document.querySelectorAll('.vendor-status-form').forEach(function(form) {
            form.addEventListener('submit', function(e) {
              e.preventDefault();
              
              if (!confirm('Konfirmasi akan menyiapkan pesanan ini?')) return;
              
              var submitBtn = form.querySelector('button[type="submit"]');
              var originalText = submitBtn.innerHTML;
              submitBtn.disabled = true;
              submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Menyiapkan...';
              
              var formData = new FormData(form);
              var orderId = formData.get('order_id') || form.getAttribute('action').split('/')[3];
              
              fetch('/vendor/orders/' + encodeURIComponent(orderId) + '/status', {
                method: 'POST',
                body: formData
              })
              .then(function(response) {
                if (!response.ok) {
                  return response.text().then(function(text) {
                    throw new Error(text || 'Server error');
                  });
                }

                // âœ… sukses: reload supaya status & badge ke-update
                location.reload();
              })
              .catch(function(error) {
                console.error('Error:', error);
                alert('Terjadi kesalahan: ' + (error.message || error));
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
              });
            });
          });
        }


        // ============================
        //  SHARED FUNCTIONALITY
        // ============================
        
        // Auto-refresh notifications
        var lastRefresh = Date.now();
        var refreshInterval = setInterval(function() {
          // Cek jika ada order baru setiap 30 detik
          if (isDriver || isVendor) {
            fetch('/api/orders/check-updates?last=' + lastRefresh, {
              headers: { 'Accept': 'application/json' }
            })
            .then(function(response) {
              if (!response.ok) return;
              return response.json();
            })
            .then(function(data) {
              if (data && data.has_updates) {
                // Tampilkan notifikasi jika ada update
                if (confirm('Ada pembaruan pesanan. Muat ulang halaman?')) {
                  location.reload();
                }
                lastRefresh = Date.now();
              }
            })
            .catch(function(error) {
              console.error('Error checking updates:', error);
            });
          }
        }, 30000); // Setiap 30 detik

        // Clean up interval saat halaman ditutup
        window.addEventListener('beforeunload', function() {
          clearInterval(refreshInterval);
        });

        // Toast notification jika ada
        var toastEl = document.getElementById('liveToast');
        if (toastEl) {
          var toast = new bootstrap.Toast(toastEl);
          toast.show();
        }

        // Tooltip initialization
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl);
        });
      });
    })();