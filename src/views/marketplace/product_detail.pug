extends ../layout

block content
  style.
    /* ===== ANIMATIONS ===== */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(15px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    body {
      background: #f8f9fa;
    }
    
    /* ===== HEADER MOBILE ===== */
    .product-header {
      background: #ffffff;
      padding: 12px 0;
      margin-bottom: 16px;
      border-bottom: 1px solid #e8e8e8;
      animation: fadeInUp 0.4s ease-out;
      position: sticky;
      top: 56px;
      z-index: 999;
    }
    
    .custom-breadcrumb {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      flex-wrap: wrap;
      padding: 0;
      margin: 0;
    }
    
    .breadcrumb-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .breadcrumb-item a {
      color: #28a745;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 3px;
      touch-action: manipulation;
    }
    
    .breadcrumb-item a:active {
      color: #218838;
    }
    
    .breadcrumb-separator {
      color: #d1d5db;
      font-size: 0.65rem;
    }
    
    .breadcrumb-current {
      color: #6c757d;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 120px;
    }
    
    /* ===== PRODUCT CONTAINER MOBILE ===== */
    .product-container {
      animation: fadeInUp 0.4s ease-out 0.1s both;
      padding-bottom: 420px !important;
    }
    
    /* ===== IMAGE SECTION MOBILE ===== */
    .image-section {
      margin-bottom: 16px;
    }
    
    .image-card {
      background: white;
      border: 1px solid #e8e8e8;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
    }
    
    .main-image-wrapper {
      position: relative;
      border-radius: 10px;
      overflow: hidden;
      background: #fafafa;
      margin-bottom: 12px;
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .main-image-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    
    .image-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f8f9fa;
    }
    
    .thumbnail-gallery {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 4px;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    
    .thumbnail-gallery::-webkit-scrollbar {
      display: none;
    }
    
    .thumbnail-item {
      width: 60px;
      height: 60px;
      border: 2px solid #e8e8e8;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      flex-shrink: 0;
      transition: all 0.2s ease;
    }
    
    .thumbnail-item.active {
      border-color: #28a745;
    }
    
    .thumbnail-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    /* ===== INFO SECTION MOBILE ===== */
    .info-section {
      animation: fadeInUp 0.4s ease-out 0.2s both;
    }
    
    .info-card {
      background: white;
      border: 1px solid #e8e8e8;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
    }
    
    .product-title {
      font-size: 1.15rem;
      font-weight: 700;
      color: #2c3e50;
      line-height: 1.4;
      margin-bottom: 12px;
    }
    
    .product-meta {
      display: flex;
      align-items: center;
      gap: 16px;
      padding-bottom: 16px;
      margin-bottom: 16px;
      border-bottom: 1px solid #f0f0f0;
      flex-wrap: wrap;
    }
    
    .meta-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.8rem;
    }
    
    .rating-icon {
      color: #ffc107;
    }
    
    .meta-value {
      font-weight: 600;
      color: #2c3e50;
    }
    
    .meta-label {
      color: #6c757d;
    }
    
    /* ===== PRICE MOBILE ===== */
    .price-section {
      background: linear-gradient(135deg, #f0f9f3 0%, #ffffff 100%);
      border: 2px solid #28a745;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .price-main {
      font-size: 1.5rem;
      font-weight: 700;
      color: #28a745;
      margin-bottom: 4px;
    }
    
    .price-unit {
      font-size: 0.8rem;
      color: #6c757d;
    }
    
    /* ===== TABS MOBILE ===== */
    .detail-tabs {
      border-bottom: 2px solid #f0f0f0;
      margin-bottom: 16px;
      display: flex;
      gap: 20px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    
    .detail-tabs::-webkit-scrollbar {
      display: none;
    }
    
    .tab-button {
      padding: 10px 0;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      color: #6c757d;
      font-weight: 600;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    
    .tab-button.active {
      color: #28a745;
      border-bottom-color: #28a745;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* ===== DETAIL GRID MOBILE ===== */
    .detail-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .detail-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .detail-label {
      font-size: 0.8rem;
      color: #6c757d;
    }
    
    .detail-value {
      font-size: 0.9rem;
      font-weight: 600;
      color: #2c3e50;
    }
    
    .detail-value.highlight {
      color: #28a745;
    }
    
    /* ===== DESCRIPTION MOBILE ===== */
    .description-box {
      background: #fafafa;
      border-left: 4px solid #28a745;
      border-radius: 8px;
      padding: 12px;
      margin-top: 12px;
    }
    
    .description-title {
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }
    
    .description-text {
      font-size: 0.8rem;
      line-height: 1.6;
      color: #4a5568;
      margin: 0;
    }
    
    /* ===== VENDOR CARD MOBILE ===== */
    .vendor-section {
      margin-bottom: 12px;
    }
    
    .vendor-card {
      background: white;
      border: 1px solid #e8e8e8;
      border-radius: 10px;
      padding: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      transition: all 0.2s ease;
    }
    
    .vendor-card:active {
      border-color: #28a745;
      box-shadow: 0 2px 8px rgba(40, 167, 69, 0.1);
    }
    
    .vendor-left {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
      min-width: 0;
    }
    
    .vendor-avatar {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.1rem;
      flex-shrink: 0;
    }
    
    .vendor-info {
      flex: 1;
      min-width: 0;
    }
    
    .vendor-name {
      display: flex;
      align-items: center;
      gap: 5px;
      font-weight: 700;
      color: #2c3e50;
      font-size: 0.85rem;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .verified-icon {
      color: #28a745;
      font-size: 0.9rem;
      flex-shrink: 0;
    }
    
    .vendor-badge {
      font-size: 0.7rem;
      color: #6c757d;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .btn-follow {
      padding: 6px 16px;
      background: white;
      color: #28a745;
      border: 2px solid #28a745;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    
    .btn-follow:active {
      background: #f0f9f3;
      transform: scale(0.97);
    }
    
    /* ===== PURCHASE CARD MOBILE (FIXED BOTTOM) ===== */
    .purchase-card {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-radius: 16px 16px 0 0;
      padding: 16px;
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      max-height: 80vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .purchase-title {
      font-size: 0.95rem;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #f0f0f0;
    }
    
    /* ===== QUANTITY MOBILE ===== */
    .quantity-section {
      margin-bottom: 16px;
    }
    
    .quantity-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .quantity-label {
      font-size: 0.8rem;
      color: #6c757d;
      font-weight: 600;
    }
    
    .stock-display {
      font-size: 0.75rem;
      color: #6c757d;
    }
    
    .stock-number {
      font-weight: 600;
      color: #2c3e50;
    }
    
    .quantity-control {
      display: flex;
      align-items: center;
      border: 2px solid #e8e8e8;
      border-radius: 10px;
      overflow: hidden;
      width: fit-content;
    }
    
    .qty-btn {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: white;
      border: none;
      color: #28a745;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    
    .qty-btn:active {
      background: #f0f9f3;
    }
    
    .qty-input {
      width: 60px;
      height: 40px;
      border: none;
      border-left: 1px solid #e8e8e8;
      border-right: 1px solid #e8e8e8;
      text-align: center;
      font-weight: 700;
      font-size: 0.95rem;
      color: #2c3e50;
    }
    
    .qty-input:focus {
      outline: none;
    }
    
    /* ===== SUBTOTAL MOBILE ===== */
    .subtotal-box {
      background: #fafafa;
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 12px;
    }
    
    .subtotal-label {
      font-size: 0.8rem;
      color: #6c757d;
      margin-bottom: 4px;
    }
    
    .subtotal-value {
      font-size: 1.4rem;
      font-weight: 700;
      color: #28a745;
    }
    
    /* ===== ACTION BUTTONS MOBILE ===== */
    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .btn-purchase {
      padding: 12px 16px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 0.9rem;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      min-height: 44px;
    }
    
    .btn-add-cart {
      background: #28a745;
      color: white;
      box-shadow: 0 2px 6px rgba(40, 167, 69, 0.3);
    }
    
    .btn-add-cart:active:not(:disabled) {
      background: #218838;
      transform: scale(0.98);
    }
    
    .btn-add-cart:disabled {
      background: #9e9e9e;
      cursor: not-allowed;
      box-shadow: none;
    }
    
    .btn-buy-now {
      background: white;
      color: #28a745;
      border: 2px solid #28a745;
    }
    
    .btn-buy-now:active {
      background: #f0f9f3;
      transform: scale(0.98);
    }
    
    /* ===== QUICK ACTIONS MOBILE ===== */
    .quick-actions {
      display: flex;
      justify-content: space-around;
      gap: 16px;
      padding-top: 12px;
      border-top: 1px solid #f0f0f0;
    }
    
    .quick-action {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      color: #6c757d;
      text-decoration: none;
      font-size: 0.7rem;
      transition: all 0.2s ease;
      cursor: pointer;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    
    .quick-action:active {
      color: #28a745;
      transform: scale(0.95);
    }
    
    .quick-action i {
      font-size: 1.15rem;
    }
    
    /* ===== LOGIN ALERT ===== */
    .login-alert {
      background: #e7f5ff;
      border: 1px solid #bee5eb;
      border-left: 4px solid #17a2b8;
      border-radius: 8px;
      padding: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.8rem;
      color: #0c5460;
    }
    
    .login-alert i {
      font-size: 1.15rem;
      color: #17a2b8;
      flex-shrink: 0;
    }
    
    /* ===== RELATED PRODUCTS MOBILE ===== */
    .related-section {
      margin-top: 20px;
      animation: fadeInUp 0.4s ease-out 0.3s both;
    }
    
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e8e8e8;
    }
    
    .section-title {
      font-size: 1.05rem;
      font-weight: 700;
      color: #2c3e50;
      margin: 0;
    }
    
    .view-all-link {
      color: #28a745;
      text-decoration: none;
      font-weight: 600;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }
    
    .view-all-link:active {
      color: #218838;
    }

    .btn-complete-profile {
      width: 100%;
      padding: 8px 14px;
      border-radius: 8px;
      font-size: .875rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      text-decoration: none;
      background: #ffc107;
      color: #2c3e50;
    }
    .btn-complete-profile:active {
      background: #ffb300;
      transform: scale(0.98);
    }
    
    /* ===== RESPONSIVE TABLET ===== */
    @media (min-width: 576px) {
      .product-container {
        padding-bottom: 420px !important;
      }

      .product-title {
        font-size: 1.3rem;
      }
      
      .price-main {
        font-size: 1.75rem;
      }
      
      .detail-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .breadcrumb-current {
        max-width: 200px;
      }
      
      .meta-item {
        font-size: 0.85rem;
      }
      
      .tab-button {
        font-size: 0.9rem;
        gap: 24px;
      }
      
      .vendor-name {
        font-size: 0.9rem;
      }
      
      .btn-follow {
        padding: 8px 20px;
        font-size: 0.85rem;
      }
    }
    
    /* ===== RESPONSIVE DESKTOP ===== */
    @media (min-width: 992px) {
      .product-container {
        padding-bottom: 0 !important;
      }
      
      .purchase-card {
        position: sticky;
        top: 20px;
        border-radius: 16px;
        max-height: none;
        padding: 20px;
      }
      
      .product-header {
        position: static;
      }
      
      .custom-breadcrumb {
        font-size: 0.875rem;
      }
      
      .breadcrumb-current {
        max-width: none;
      }
      
      .product-title {
        font-size: 1.5rem;
      }
      
      .price-main {
        font-size: 2rem;
      }
      
      .info-card {
        padding: 24px;
      }
      
      .purchase-card {
        padding: 20px;
      }
      
      .purchase-title {
        font-size: 1rem;
      }
    }

  .product-header
    .container
      nav.custom-breadcrumb
        .breadcrumb-item
          a(href="/market")
            i.bi.bi-house-door-fill
            span.d-none.d-sm-inline Home
        span.breadcrumb-separator
          i.bi.bi-chevron-right
        if product && product.category
          .breadcrumb-item
            a(href=`/market?category=${product.category}`)= product.category
          span.breadcrumb-separator.d-none.d-sm-inline
            i.bi.bi-chevron-right
        span.breadcrumb-current= (product && product.name) || 'Detail'

  .container.py-3.py-md-4.product-container
    .row.g-3.g-md-4
      //- Left: Image
      .col-lg-5
        .image-section
          .image-card
            .main-image-wrapper
              if product && product.image
                img(src=product.image alt=(product.name||'Produk'))
              else
                .image-placeholder
                  i.bi.bi-image.text-muted(style="font-size: 3rem;")

            .thumbnail-gallery
              .thumbnail-item.active
                if product && product.image
                  img(src=product.image alt="Thumbnail")

      //- Right: Info & Purchase
      .col-lg-7.info-section
        //- Info Card
        .info-card
          h1.product-title= (product && product.name) || 'Nama Produk'
          
          .product-meta
            .meta-item
              i.bi.bi-star-fill.rating-icon
              span.meta-value 4.9
              span.meta-label.d-none.d-sm-inline (94 ulasan)
            
            .meta-item
              i.bi.bi-box-seam.text-success
              span.meta-label Terjual
              span.meta-value 750+

          //- Price
          .price-section
            .price-main
              | Rp#{Number((product && product.price) || 0).toLocaleString('id-ID')}
            if product && product.unit
              .price-unit per #{product.unit}

          //- Tabs
          .detail-tabs
            button.tab-button.active(onclick="switchTab('detail')") Detail
            button.tab-button(onclick="switchTab('info')") Info

          //- Tab: Detail
          .tab-content.active#tab-detail
            .detail-grid
              .detail-row
                .detail-label Kondisi
                .detail-value Baru
              
              .detail-row
                .detail-label Min. Pemesanan
                .detail-value 1 #{(product && product.unit) || 'Buah'}
              
              .detail-row
                .detail-label Kategori
                .detail-value.highlight= (product && product.category) || 'Umum'
              
              .detail-row
                .detail-label Stok Tersedia
                .detail-value= Number((product && product.stock) || 0).toLocaleString('id-ID') + ' ' + ((product && product.unit) || '')

            if product && product.description
              .description-box
                .description-title Deskripsi
                p.description-text= product.description

          //- Tab: Info
          .tab-content#tab-info
            .description-box
              .description-title Informasi Penting
              p.description-text Produk dijual oleh vendor terpercaya dan telah melalui verifikasi kualitas.

        //- Vendor Card
        if product && product.yayasan_name
          .vendor-section
            .vendor-card
              .vendor-left
                .vendor-avatar
                  i.bi.bi-heart-fill
                .vendor-info
                  .vendor-name
                    span= product.yayasan_name
                    i.bi.bi-patch-check-fill.verified-icon
                  .vendor-badge
                    i.bi.bi-shield-check
                    span.d-none.d-sm-inline Terverifikasi
              button.btn-follow
                i.bi.bi-plus-circle.me-1
                | Ikuti

        //- Purchase Card (Fixed on mobile)
        .purchase-card
          if currentUser && currentUser.role === 'dapur' 
            if !(currentUser.phone && currentUser.address)
              a.btn-complete-profile(
                href="/dapur/profile/complete"
                title="Lengkapi data dapur"
              )
                i.bi.bi-exclamation-circle
                |  Lengkapi Data Dapur
            else
              .purchase-title Atur Jumlah

              form(action="/dapur/cart/add" method="post")
                input(type="hidden" name="product_id" value=(product && product.id))
                
                .quantity-section
                  .quantity-header
                    .quantity-label Jumlah
                    .stock-display
                      | Stok: 
                      span.stock-number= Number((product && product.stock) || 0).toLocaleString('id-ID')
                  
                  .quantity-control
                    button.qty-btn(type="button" onclick="decrementQty()")
                      i.bi.bi-dash
                    input#qtyInput.qty-input(
                      type="number"
                      name="qty"
                      value="1"
                      min="1"
                      readonly
                    )
                    button.qty-btn(type="button" onclick="incrementQty()")
                      i.bi.bi-plus

                .subtotal-box
                  .subtotal-label Subtotal
                  .subtotal-value#subtotalPrice
                    | Rp#{Number((product && product.price) || 0).toLocaleString('id-ID')}

                .action-buttons
                  button.btn-purchase.btn-add-cart(
                    type="submit" 
                    disabled=!((product && product.stock) && Number(product.stock) > 0)
                  )
                    i.bi.bi-cart-plus
                    span.d-none.d-sm-inline Tambah ke Keranjang
                    span.d-inline.d-sm-none Keranjang
                  
                  button.btn-purchase.btn-buy-now(type="button")
                    i.bi.bi-lightning-charge-fill
                    span Beli Langsung

                .quick-actions
                  a.quick-action(href="#")
                    i.bi.bi-chat-dots-fill
                    span Chat
                  a.quick-action(href="#")
                    i.bi.bi-heart-fill
                    span Wishlist
                  a.quick-action(href="#")
                    i.bi.bi-share-fill
                    span Share
          else
            .login-alert
              i.bi.bi-info-circle-fill
              span Login sebagai Dapur untuk menambahkan ke keranjang

    //- Related Products
    if relatedProducts && relatedProducts.length > 0
      .related-section
        .section-header
          h2.section-title Produk Serupa
          a.view-all-link(href="/market")
            span Lihat Semua
            i.bi.bi-arrow-right

        .row.g-2.g-md-3
          each relProduct in relatedProducts.slice(0, 6)
            .col-6.col-md-4.col-lg-2
              - var product = relProduct
              include _product_card

  script.
    const productPrice = #{(product && product.price) || 0};
    
    function incrementQty() {
      const input = document.getElementById('qtyInput');
      let current = parseInt(input.value, 10);
      if (isNaN(current) || current < 1) current = 1;
      input.value = current + 1;
      updateSubtotal();
    }
    
    function decrementQty() {
      const input = document.getElementById('qtyInput');
      const min = parseInt(input.min, 10) || 1;
      let current = parseInt(input.value, 10);
      if (isNaN(current) || current < min) current = min;
      if (current > min) {
        input.value = current - 1;
        updateSubtotal();
      }
    }