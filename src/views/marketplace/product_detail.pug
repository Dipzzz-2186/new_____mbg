//- src/views/marketplace/product_detail.pug
extends ../layout

block content
  style.
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    body {
      background: #f8f9fa;
    }
    
    /* Page Header */
    .product-header {
      background: #ffffff;
      padding: 16px 0;
      margin-bottom: 24px;
      border-bottom: 1px solid #e8e8e8;
      animation: fadeInUp 0.6s ease-out;
    }
    
    /* Breadcrumb */
    .custom-breadcrumb {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.875rem;
      flex-wrap: wrap;
      padding: 0;
      margin: 0;
    }
    
    .breadcrumb-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .breadcrumb-item a {
      color: #28a745;
      text-decoration: none;
      transition: color 0.2s ease;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .breadcrumb-item a:hover {
      color: #218838;
    }
    
    .breadcrumb-separator {
      color: #d1d5db;
      font-size: 0.7rem;
    }
    
    .breadcrumb-current {
      color: #6c757d;
    }
    
    /* Product Container */
    .product-container {
      animation: fadeInUp 0.6s ease-out 0.2s both;
    }
    
    /* Left Column - Image */
    .image-section {
      margin-bottom: 24px;
    }
    
    .image-card {
      background: white;
      border: 1px solid #e8e8e8;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }
    
    .main-image-wrapper {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      background: #fafafa;
      margin-bottom: 16px;
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .main-image-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    
    .image-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f8f9fa;
    }
    
    .thumbnail-gallery {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      padding-bottom: 4px;
    }
    
    .thumbnail-item {
      width: 70px;
      height: 70px;
      border: 2px solid #e8e8e8;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      flex-shrink: 0;
      transition: all 0.2s ease;
    }
    
    .thumbnail-item:hover,
    .thumbnail-item.active {
      border-color: #28a745;
    }
    
    .thumbnail-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    /* Right Column - Info */
    .info-section {
      animation: slideInRight 0.6s ease-out 0.3s both;
    }
    
    .info-card {
      background: white;
      border: 1px solid #e8e8e8;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }
    
    /* Product Title */
    .product-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #2c3e50;
      line-height: 1.4;
      margin-bottom: 16px;
    }
    
    /* Meta Info */
    .product-meta {
      display: flex;
      align-items: center;
      gap: 20px;
      padding-bottom: 20px;
      margin-bottom: 20px;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .meta-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.875rem;
    }
    
    .rating-icon {
      color: #ffc107;
    }
    
    .meta-value {
      font-weight: 600;
      color: #2c3e50;
    }
    
    .meta-label {
      color: #6c757d;
    }
    
    /* Price Section */
    .price-section {
      background: linear-gradient(135deg, #f0f9f3 0%, #ffffff 100%);
      border: 2px solid #28a745;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .price-main {
      font-size: 2rem;
      font-weight: 700;
      color: #28a745;
      margin-bottom: 4px;
    }
    
    .price-unit {
      font-size: 0.875rem;
      color: #6c757d;
    }
    
    /* Tabs */
    .detail-tabs {
      border-bottom: 2px solid #f0f0f0;
      margin-bottom: 20px;
      display: flex;
      gap: 24px;
    }
    
    .tab-button {
      padding: 12px 0;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      color: #6c757d;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .tab-button:hover {
      color: #28a745;
    }
    
    .tab-button.active {
      color: #28a745;
      border-bottom-color: #28a745;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Detail Grid */
    .detail-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .detail-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .detail-label {
      font-size: 0.875rem;
      color: #6c757d;
    }
    
    .detail-value {
      font-size: 0.95rem;
      font-weight: 600;
      color: #2c3e50;
    }
    
    .detail-value.highlight {
      color: #28a745;
    }
    
    /* Description */
    .description-box {
      background: #fafafa;
      border-left: 4px solid #28a745;
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
    }
    
    .description-title {
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 8px;
      font-size: 0.95rem;
    }
    
    .description-text {
      font-size: 0.875rem;
      line-height: 1.7;
      color: #4a5568;
      margin: 0;
    }
    
    /* Vendor Card */
    .vendor-section {
      margin-bottom: 16px;
    }
    
    .vendor-card {
      background: white;
      border: 1px solid #e8e8e8;
      border-radius: 12px;
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      transition: all 0.3s ease;
    }
    
    .vendor-card:hover {
      border-color: #28a745;
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.1);
    }
    
    .vendor-left {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }
    
    .vendor-avatar {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.25rem;
      flex-shrink: 0;
    }
    
    .vendor-info {
      flex: 1;
    }
    
    .vendor-name {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 700;
      color: #2c3e50;
      font-size: 0.95rem;
      margin-bottom: 2px;
    }
    
    .verified-icon {
      color: #28a745;
      font-size: 1rem;
    }
    
    .vendor-badge {
      font-size: 0.75rem;
      color: #6c757d;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .btn-follow {
      padding: 8px 20px;
      background: white;
      color: #28a745;
      border: 2px solid #28a745;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }
    
    .btn-follow:hover {
      background: #28a745;
      color: white;
    }
    
    /* Purchase Card */
    .purchase-card {
      background: white;
      border: 1px solid #e8e8e8;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      position: sticky;
      top: 20px;
    }
    
    .purchase-title {
      font-size: 1rem;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid #f0f0f0;
    }
    
    /* Quantity Section */
    .quantity-section {
      margin-bottom: 20px;
    }
    
    .quantity-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .quantity-label {
      font-size: 0.875rem;
      color: #6c757d;
      font-weight: 600;
    }
    
    .stock-display {
      font-size: 0.75rem;
      color: #6c757d;
    }
    
    .stock-number {
      font-weight: 600;
      color: #2c3e50;
    }
    
    .quantity-control {
      display: flex;
      align-items: center;
      border: 2px solid #e8e8e8;
      border-radius: 10px;
      overflow: hidden;
      width: fit-content;
    }
    
    .qty-btn {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: white;
      border: none;
      color: #28a745;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .qty-btn:hover {
      background: #f0f9f3;
    }
    
    .qty-input {
      width: 60px;
      height: 40px;
      border: none;
      border-left: 1px solid #e8e8e8;
      border-right: 1px solid #e8e8e8;
      text-align: center;
      font-weight: 700;
      font-size: 1rem;
      color: #2c3e50;
    }
    
    .qty-input:focus {
      outline: none;
    }
    
    /* Subtotal */
    .subtotal-box {
      background: #fafafa;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .subtotal-label {
      font-size: 0.875rem;
      color: #6c757d;
      margin-bottom: 6px;
    }
    
    .subtotal-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: #28a745;
    }
    
    /* Action Buttons */
    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 16px;
    }
    
    .btn-purchase {
      padding: 14px 20px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 0.95rem;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-add-cart {
      background: #28a745;
      color: white;
      box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
    }
    
    .btn-add-cart:hover:not(:disabled) {
      background: #218838;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
    }
    
    .btn-add-cart:disabled {
      background: #9e9e9e;
      cursor: not-allowed;
      box-shadow: none;
    }
    
    .btn-buy-now {
      background: white;
      color: #28a745;
      border: 2px solid #28a745;
    }
    
    .btn-buy-now:hover {
      background: #f0f9f3;
      transform: translateY(-1px);
    }
    
    /* Quick Actions */
    .quick-actions {
      display: flex;
      justify-content: center;
      gap: 24px;
      padding-top: 16px;
      border-top: 1px solid #f0f0f0;
    }
    
    .quick-action {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      color: #6c757d;
      text-decoration: none;
      font-size: 0.75rem;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .quick-action:hover {
      color: #28a745;
    }
    
    .quick-action i {
      font-size: 1.25rem;
    }
    
    /* Login Alert */
    .login-alert {
      background: #e7f5ff;
      border: 1px solid #bee5eb;
      border-left: 4px solid #17a2b8;
      border-radius: 10px;
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 0.875rem;
      color: #0c5460;
    }
    
    .login-alert i {
      font-size: 1.25rem;
      color: #17a2b8;
      flex-shrink: 0;
    }
    
    /* Related Products */
    .related-section {
      margin-top: 40px;
      animation: fadeInUp 0.6s ease-out 0.4s both;
    }
    
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid #e8e8e8;
    }
    
    .section-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #2c3e50;
      margin: 0;
    }
    
    .view-all-link {
      color: #28a745;
      text-decoration: none;
      font-weight: 600;
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all 0.2s ease;
    }
    
    .view-all-link:hover {
      color: #218838;
      gap: 8px;
    }
    .btn-complete-profile {
      width: 100%;
      padding: 8px 14px;
      border-radius: 8px;
      font-size: .875rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      text-decoration: none;
    }
    .btn-complete-profile {
      background: #ffc107;
      color: #2c3e50;
    }
    .btn-complete-profile:hover {
      background: #ffb300;
    }

    
    /* Mobile Responsive */
    @media (max-width: 991px) {
      .purchase-card {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        border-radius: 16px 16px 0 0;
        z-index: 1000;
        box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.1);
        max-height: 85vh;
        overflow-y: auto;
      }
      
      .product-container {
        padding-bottom: 100px;
      }
    }
    
    @media (max-width: 576px) {
      .product-title {
        font-size: 1.25rem;
      }
      
      .price-main {
        font-size: 1.75rem;
      }
      
      .detail-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .info-card {
        padding: 16px;
      }
      
      .purchase-card {
        padding: 16px;
      }
      
      .product-meta {
        gap: 12px;
      }
      
      .detail-tabs {
        gap: 16px;
        overflow-x: auto;
      }
    }

  .product-header
    .container
      nav.custom-breadcrumb
        .breadcrumb-item
          a(href="/market")
            i.bi.bi-house-door-fill
            span Home
        span.breadcrumb-separator
          i.bi.bi-chevron-right
        if product && product.category
          .breadcrumb-item
            a(href=`/market?category=${product.category}`)= product.category
          span.breadcrumb-separator
            i.bi.bi-chevron-right
        span.breadcrumb-current= (product && product.name) || 'Detail Produk'

  .container.py-4.product-container
    .row.g-4
      //- Left Column: Image
      .col-lg-5
        .image-section
          .image-card
            .main-image-wrapper
              if product && product.image
                img(src=product.image alt=(product.name||'Produk'))
              else
                .image-placeholder
                  i.bi.bi-image.text-muted(style="font-size: 4rem;")

            .thumbnail-gallery
              .thumbnail-item.active
                if product && product.image
                  img(src=product.image alt="Thumbnail")

      //- Right Column: Info & Purchase
      .col-lg-7.info-section
        //- Product Info Card
        .info-card
          h1.product-title= (product && product.name) || 'Nama Produk'
          
          .product-meta
            .meta-item
              i.bi.bi-star-fill.rating-icon
              span.meta-value 4.9
              span.meta-label (94 ulasan)
            
            .meta-item
              i.bi.bi-box-seam.text-success
              span.meta-label Terjual
              span.meta-value 750+

          //- Price
          .price-section
            .price-main
              | Rp#{Number((product && product.price) || 0).toLocaleString('id-ID')}
            if product && product.unit
              .price-unit per #{product.unit}

          //- Tabs
          .detail-tabs
            button.tab-button.active(onclick="switchTab('detail')") Detail Produk
            button.tab-button(onclick="switchTab('info')") Info Penting

          //- Tab Content: Detail
          .tab-content.active#tab-detail
            .detail-grid
              .detail-row
                .detail-label Kondisi
                .detail-value Baru
              
              .detail-row
                .detail-label Min. Pemesanan
                .detail-value 1 #{(product && product.unit) || 'Buah'}
              
              .detail-row
                .detail-label Kategori
                .detail-value.highlight= (product && product.category) || 'Umum'
              
              .detail-row
                .detail-label Stok Tersedia
                .detail-value= Number((product && product.stock) || 0).toLocaleString('id-ID') + ' ' + ((product && product.unit) || '')

            if product && product.description
              .description-box
                .description-title Deskripsi Produk
                p.description-text= product.description

          //- Tab Content: Info
          .tab-content#tab-info
            .description-box
              .description-title Informasi Penting
              p.description-text Produk ini dijual oleh vendor terpercaya dan telah melalui proses verifikasi kualitas. Pastikan untuk memeriksa kondisi produk saat diterima.

        //- Vendor Card
        if product && product.yayasan_name
          .vendor-section
            .vendor-card
              .vendor-left
                .vendor-avatar
                  i.bi.bi-heart-fill
                .vendor-info
                  .vendor-name
                    span= product.yayasan_name
                    i.bi.bi-patch-check-fill.verified-icon
                  .vendor-badge
                    i.bi.bi-shield-check
                    span Terverifikasi
              button.btn-follow
                i.bi.bi-plus-circle.me-1
                | Ikuti

        //- Purchase Card
        .purchase-card
          if currentUser && currentUser.role === 'dapur' 
            if !(currentUser.phone && currentUser.address)
                a.btn-complete-profile(
                  href="/dapur/profile/complete"
                  onclick="event.stopPropagation()"
                  title="Lengkapi data dapur"
                )
                  i.bi.bi-exclamation-circle
                  |  Lengkapi Data Dapur
            else
              .purchase-title Atur Jumlah Pembelian

              form(action="/dapur/cart/add" method="post")
                input(type="hidden" name="product_id" value=(product && product.id))
                
                .quantity-section
                  .quantity-header
                    .quantity-label Jumlah
                    .stock-display
                      | Stok: 
                      span.stock-number= Number((product && product.stock) || 0).toLocaleString('id-ID')
                  
                  .quantity-control
                    button.qty-btn(type="button" onclick="decrementQty()")
                      i.bi.bi-dash
                    input#qtyInput.qty-input(
                      type="number"
                      name="qty"
                      value="1"
                      min="1"
                      readonly
                    )
                    button.qty-btn(type="button" onclick="incrementQty()")
                      i.bi.bi-plus

                .subtotal-box
                  .subtotal-label Subtotal
                  .subtotal-value#subtotalPrice
                    | Rp#{Number((product && product.price) || 0).toLocaleString('id-ID')}

                .action-buttons
                  button.btn-purchase.btn-add-cart(
                    type="submit" 
                    disabled=!((product && product.stock) && Number(product.stock) > 0)
                  )
                    i.bi.bi-cart-plus
                    span Tambah ke Keranjang
                  
                  button.btn-purchase.btn-buy-now(type="button")
                    i.bi.bi-lightning-charge-fill
                    span Beli Langsung

                .quick-actions
                  a.quick-action(href="#")
                    i.bi.bi-chat-dots-fill
                    span Chat
                  a.quick-action(href="#")
                    i.bi.bi-heart-fill
                    span Wishlist
                  a.quick-action(href="#")
                    i.bi.bi-share-fill
                    span Share
          else
            .login-alert
              i.bi.bi-info-circle-fill
              span Silakan login sebagai Dapur untuk menambahkan produk ke keranjang

    //- Related Products
    if relatedProducts && relatedProducts.length > 0
      .related-section
        .section-header
          h2.section-title Produk Serupa
          a.view-all-link(href="/market")
            span Lihat Semua
            i.bi.bi-arrow-right

        .row.g-3
          each relProduct in relatedProducts.slice(0, 6)
            .col-6.col-md-4.col-lg-2
              - var product = relProduct
              include _product_card

  //- JavaScript
  script.
    const productPrice = #{(product && product.price) || 0};
    
    function incrementQty() {
      const input = document.getElementById('qtyInput');
      let current = parseInt(input.value, 10);
      if (isNaN(current) || current < 1) current = 1;
      input.value = current + 1;
      updateSubtotal();
    }
    
    function decrementQty() {
      const input = document.getElementById('qtyInput');
      const min = parseInt(input.min, 10) || 1;
      let current = parseInt(input.value, 10);
      if (isNaN(current) || current < min) current = min;
      if (current > min) {
        input.value = current - 1;
        updateSubtotal();
      }
    }

    function updateSubtotal() {
      const qty = parseInt(document.getElementById('qtyInput').value, 10) || 1;
      const subtotal = productPrice * qty;
      document.getElementById('subtotalPrice').textContent = 
        'Rp' + subtotal.toLocaleString('id-ID');
    }
    
    function switchTab(tabId) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Remove active from all buttons
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Show selected tab
      document.getElementById('tab-' + tabId).classList.add('active');
      
      // Add active to clicked button
      event.target.classList.add('active');
    }