//- src/views/marketplace/product_detail.pug
extends ../layout

block content
  .container.py-3
    // Breadcrumb
    nav(aria-label="breadcrumb")
      ol.breadcrumb.mb-3
        li.breadcrumb-item
          a.text-success(href="/market" style="text-decoration: none; font-size: 0.875rem;") Home
        if product && product.category
          li.breadcrumb-item
            a.text-success(href=`/market?category=${product.category}` style="text-decoration: none; font-size: 0.875rem;")= product.category
        li.breadcrumb-item.active(aria-current="page" style="font-size: 0.875rem;")= (product && product.name) || 'Detail Produk'

    .row.g-3
      // Left: Image Section
      .col-lg-5
        .card.border(style="border-radius: 8px; border-color: #e5e5e5;")
          .card-body.p-3
            .position-relative.mb-3
              if product && product.image
                img.img-fluid.w-100(src=product.image alt=(product.name||'Produk') style="border-radius: 8px; max-height: 450px; object-fit: contain;")
              else
                .bg-light.d-flex.align-items-center.justify-content-center(style="height:450px; border-radius: 8px;")
                  i.bi.bi-image.text-muted(style="font-size: 5rem;")
              
              // Discount badge (if applicable)
              //- .position-absolute.top-0.start-0.m-2
              //-   span.badge.bg-danger(style="font-size:0.75rem; border-radius:4px; padding: 4px 8px;") 53%

            // Thumbnail gallery (optional)
            .d-flex.gap-2.overflow-auto
              .border.rounded(style="width: 60px; height: 60px; flex-shrink: 0; cursor: pointer;")
                if product && product.image
                  img.w-100.h-100(src=product.image style="object-fit: cover; border-radius: 4px;")

      // Right: Product Info
      .col-lg-7
        .mb-3
          // Product Name
          h1.fw-bold.mb-2(style="color:#212121; font-size: 1.25rem; line-height:1.4;")= (product && product.name) || 'Nama Produk'
          
          // Rating & Sold
          .d-flex.align-items-center.gap-3.mb-3
            .d-flex.align-items-center
              span.text-muted(style="font-size: 0.875rem;") Terjual 
              strong.ms-1 750+
            .d-flex.align-items-center
              i.bi.bi-star-fill.text-warning.me-1(style="font-size: 0.875rem;")
              strong.me-1 4.9
              span.text-muted(style="font-size: 0.875rem;") (94 rating)

        // Price Section
        .card.border.mb-3(style="border-radius: 8px; border-color: #e5e5e5;")
          .card-body.p-3
            .d-flex.align-items-baseline.gap-2.mb-2
              h2.fw-bold.mb-0(style="font-size: 1.75rem; color: #212121;")
                | Rp#{Number((product && product.price) || 0).toLocaleString('id-ID')}
              //- Original price with strikethrough
              //- span.text-muted.text-decoration-line-through(style="font-size: 0.875rem;") Rp16.000
              //- Discount badge
              //- span.badge.bg-danger(style="font-size: 0.75rem; border-radius: 4px;") 53%

            if product && product.unit
              .text-muted(style="font-size: 0.875rem;") per #{product.unit}

        // Detail Produk & Info Penting Tabs
        .mb-3
          ul.nav.nav-tabs.border-bottom(style="border-color: #e5e5e5 !important;")
            li.nav-item
              a.nav-link.active(href="#detail" data-bs-toggle="tab" style="color: #03ac0e; border-bottom: 2px solid #03ac0e; font-weight: 600; font-size: 0.875rem;") Detail Produk
            li.nav-item
              a.nav-link(href="#info" data-bs-toggle="tab" style="color: #6d6d6d; font-size: 0.875rem;") Info Penting

          .tab-content.pt-3
            #detail.tab-pane.fade.show.active
              .row.g-2.mb-3(style="font-size: 0.875rem;")
                .col-6
                  .text-muted Kondisi:
                  strong.text-dark Baru
                .col-6
                  .text-muted Min. Pemesanan:
                  strong.text-dark 1 Buah
                .col-6
                  .text-muted Etalase:
                  strong.text-success Semua Etalase
                .col-6
                  .text-muted Stok:
                  strong.text-dark #{ Number((product && product.stock) || 0).toLocaleString('id-ID') } #{ (product && product.unit) || '' }

              if product && product.description
                hr.my-3
                .text-muted(style="font-size: 0.875rem; line-height: 1.6;")
                  strong.text-dark.d-block.mb-2 Detail produk:
                  = product.description

            #info.tab-pane.fade
              .text-muted(style="font-size: 0.875rem;")
                p Informasi penting tentang produk ini.

        // Info Yayasan
        if product && product.yayasan_name
          .card.border.mb-3(style="border-radius: 8px; border-color: #e5e5e5;")
            .card-body.p-3
              .d-flex.align-items-center.justify-content-between
                .d-flex.align-items-center.gap-2
                  .bg-primary.rounded-circle.d-flex.align-items-center.justify-content-center(style="width: 48px; height: 48px;")
                    i.bi.bi-heart-fill.text-white(style="font-size: 1.25rem;")
                  div
                    .d-flex.align-items-center.gap-2
                      i.bi.bi-patch-check-fill.text-primary
                      strong(style="font-size: 0.875rem;")= product.yayasan_name
                    .d-flex.align-items-center.gap-2.mt-1(style="font-size: 0.75rem;")
                      i.bi.bi-people-fill.text-primary
                      span Terverifikasi
                button.btn.btn-sm.btn-outline-primary(style="border-radius: 8px; font-size: 0.75rem; font-weight: 600;") Ikuti Yayasan

        // Action Section - Sticky on mobile
        .card.border.sticky-bottom.bg-white(style="border-radius: 8px 8px 0 0; border-color: #e5e5e5; bottom: 0; z-index: 100;")
          .card-body.p-3
            if currentUser && currentUser.role === 'dapur'
              h6.fw-bold.mb-3(style="font-size: 0.875rem;") Atur jumlah dan catatan

              form(action="/dapur/cart/add" method="post")
                input(type="hidden" name="product_id" value=(product && product.id))
                
                .d-flex.align-items-center.justify-content-between.mb-3
                  .d-flex.align-items-center.gap-3
                  .input-group(style="width: 110px;")
                    button.btn.btn-outline-secondary.btn-sm(
                      type="button"
                      onclick="decrementQty()"
                      style="border-radius: 8px 0 0 8px;"
                    )
                      i.bi.bi-dash
                    input#qtyInput.form-control.form-control-sm.text-center.fw-bold(
                      type="number"
                      name="qty"
                      value="1"
                      min="1"
                      step="1"
                      style="border-left: none; border-right: none;"
                    )
                    button.btn.btn-outline-secondary.btn-sm(
                      type="button"
                      onclick="incrementQty()"
                      style="border-radius: 0 8px 8px 0;"
                    )
                      i.bi.bi-plus

                  div(style="text-align: right;")
                    .text-muted(style="font-size: 0.75rem;") Stok Total: 
                      strong.text-dark= Number((product && product.stock) || 0).toLocaleString('id-ID')
                    .text-muted.small(style="font-size: 0.75rem; text-decoration: line-through;") Rp16.000
                    .fw-bold.text-dark Subtotal
                    .fw-bold(style="font-size: 1.25rem; color: #212121;")
                      | Rp#{Number((product && product.price) || 0).toLocaleString('id-ID')}

                .d-grid.gap-2
                  button.btn.btn-success.btn-lg(type="submit" disabled=!((product && product.stock) && Number(product.stock) > 0) style="border-radius: 8px; font-weight: 600; font-size: 0.875rem;")
                    i.bi.bi-cart-plus.me-2
                    | + Keranjang
                  button.btn.btn-outline-success.btn-lg(type="button" style="border-radius: 8px; font-weight: 600; font-size: 0.875rem;")
                    | Beli Langsung

                .d-flex.gap-3.mt-3.justify-content-center
                  a.text-muted(href="#" style="font-size: 0.875rem; text-decoration: none;")
                    i.bi.bi-chat-dots.me-1
                    | Chat
                  a.text-muted(href="#" style="font-size: 0.875rem; text-decoration: none;")
                    i.bi.bi-heart.me-1
                    | Wishlist
                  a.text-muted(href="#" style="font-size: 0.875rem; text-decoration: none;")
                    i.bi.bi-share.me-1
                    | Share

            else
              .alert.alert-info.mb-0.small
                i.bi.bi-info-circle.me-2
                | Silakan login sebagai Dapur untuk menambahkan produk ke keranjang

    // Related Products Section
    if relatedProducts && relatedProducts.length > 0
      .mt-4
        .d-flex.justify-content-between.align-items-center.mb-3
          h5.fw-bold.mb-0(style="font-size: 1.125rem;") Produk Serupa
          a.text-success(href="/market" style="text-decoration:none; font-size: 0.875rem;") Lihat Semua 
            i.bi.bi-chevron-right

        .row.g-2
          each relProduct in relatedProducts.slice(0, 6)
            .col-6.col-md-4.col-lg-2
              - var product = relProduct
              include _product_card

  // JavaScript for quantity controls
  script.
    function incrementQty() {
      const input = document.getElementById('qtyInput');
      let current = parseInt(input.value, 10);
      if (isNaN(current) || current < 1) current = 1;
      input.value = current + 1;
      updateSubtotal();
    }
    
    function decrementQty() {
      const input = document.getElementById('qtyInput');
      const min = parseInt(input.min, 10) || 1;
      let current = parseInt(input.value, 10);
      if (isNaN(current) || current < min) current = min;
      if (current > min) {
        input.value = current - 1;
        updateSubtotal();
      }
    }

    function updateSubtotal() {
      // TODO: kalau mau, hitung ulang subtotal di detail page
    }


  style
    | .nav-tabs .nav-link { border: none; padding: 0.75rem 1rem; }
    | .nav-tabs .nav-link:hover { color: #03ac0e; }
    | .nav-tabs .nav-link.active { background: none; border: none; border-bottom: 2px solid #03ac0e !important; }
    | .breadcrumb-item + .breadcrumb-item::before { content: ">"; color: #9e9e9e; }
    | @media (max-width: 991px) {
    |   .sticky-bottom { position: sticky; margin-left: -12px; margin-right: -12px; border-radius: 8px 8px 0 0; box-shadow: 0 -2px 8px rgba(0,0,0,0.1); }
    | }