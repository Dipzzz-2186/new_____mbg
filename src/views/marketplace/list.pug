extends ../layout

block content
  //- ===== HERO / BANNER ATAS =====
  .hero-banner-wrapper.mb-5
    .hero-banner
      //- Gambar full, tidak dipotong
      img.hero-bg(src="/img/sembako.jpg" alt="Sembako segar FreshMart")

      .hero-overlay
      .hero-content.container
        .row.align-items-center
          .col-lg-7.col-md-8
            h1.hero-title.mb-3
              | Belanja Bahan Makanan
              br
              | Lebih Mudah & Segar
            p.hero-subtitle.mb-4
              | Pilih berbagai bahan berkualitas dari vendor terpercaya untuk kebutuhan dapur dan yayasan.
            .d-flex.flex-wrap.gap-3
              a.btn.btn-success.btn-lg.shadow(
                href="#productsSection"
              )
                i.bi.bi-bag-check-fill.me-2
                | Belanja Sekarang
              if currentUser && currentUser.role === 'vendor'
                a.btn.btn-outline-light.btn-lg(
                  href="/vendor/products/new"
                )
                  i.bi.bi-plus-circle.me-2
                  | Tambah Produk
          .col-lg-5.d-none.d-lg-block
            .hero-illust.float-animation
              i.bi.bi-basket2-fill

      a.scroll-down-indicator(href="#productsSection")
        i.bi.bi-chevron-double-down

  //- ===== HEADER KECIL DI ATAS PRODUK =====
  .marketplace-header.mb-2
    .d-flex.justify-content-between.align-items-center.flex-wrap.gap-3.animate-fadeIn
      div
        h2.mb-1.fw-bold.text-success(style="font-size: 1.4rem;")
          i.bi.bi-shop-window.me-2
          | Semua Produk
        p.text-muted.mb-0(style="font-size: 0.95rem;")
          | Temukan bahan yang cocok untuk kebutuhan harian maupun event besar.

  //- ===== BAR URUTKAN HARGA =====
  .sort-bar.mb-3.d-flex.justify-content-end.align-items-center.flex-wrap.gap-2
    span.text-muted.small.me-1 Urutkan:
    button.btn-sort(data-sort="asc" type="button")
      i.bi.bi-arrow-down-up.me-1
      | Harga Termurah
    button.btn-sort(data-sort="desc" type="button")
      i.bi.bi-arrow-up-down.me-1
      | Harga Tertinggi

  //- ===== KATEGORI FILTER MODEL IKON =====
  .section-category.mb-4
    h5.mb-3.fw-bold.text-success KATEGORI
    .category-grid
      .category-item(data-cat="Sayur")
        i.bi.bi-flower3.category-icon
        span Sayuran

      .category-item(data-cat="Daging")
        i.bi.bi-egg-fried.category-icon
        span Daging

      .category-item(data-cat="Sembako")
        i.bi.bi-basket3.category-icon
        span Sembako

      .category-item(data-cat="other")
        i.bi.bi-grid-3x3-gap-fill.category-icon
        span Lain Lainnya

  //- ===== PRODUCTS GRID (TARGET SMOOTH SCROLL) =====
  section#productsSection
    #productsGrid
      if products && products.length
        .row.g-4#productsRow
          each p in products
            //- data-cat untuk filter kategori, fallback ke 'other' kalau kosong
            .col-lg-3.col-md-4.col-sm-6(
              data-cat=(p.category || 'other')
              data-price=(p.price || 0)
            )
              - var product = p
              include ../marketplace/_product_card.pug
      else
        .card.border-0.shadow.text-center.py-5.animate-fadeIn(style="border-radius: 15px;")
          .card-body.p-5
            .mb-4
              i.bi.bi-basket3.text-success(style="font-size: 5rem; opacity: 0.3;")
            h4.mt-4.mb-3.fw-bold.text-success Belum Ada Produk
            p.text-muted.mb-0(style="font-size: 1.1rem;")
              i.bi.bi-info-circle.me-2
              | Produk akan ditampilkan di sini

  //- ===== CSS KHUSUS HALAMAN INI =====
  style.
    /* HERO FULL BLEED */
    .hero-banner-wrapper {
      position: relative;
      margin-left: 50%;
      margin-right: 50%;
      left: -50vw;
      right: -50vw;
      width: 100vw;
    }
    .hero-banner {
      position: relative;
      min-height: 320px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 0 0 24px 24px;
      overflow: hidden;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.18);
      background: radial-gradient(circle at top left, #ecfdf5 0, #f9fafb 40%, #e5e7eb 100%);
    }
    /* Gambar tidak dipotong */
    .hero-bg {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      object-position: center;
      pointer-events: none;
    }
    .hero-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, rgba(15, 23, 42, 0.72), rgba(15, 23, 42, 0.25), rgba(15, 23, 42, 0.05));
    }
    .hero-content {
      position: relative;
      z-index: 1;
      padding-top: 2.5rem;
      padding-bottom: 2.5rem;
      color: #f9fafb;
    }
    .hero-title {
      font-size: 2.3rem;
      font-weight: 800;
      line-height: 1.25;
    }
    .hero-subtitle {
      font-size: 1.02rem;
      max-width: 32rem;
      color: #e5e7eb;
    }
    .hero-illust {
      width: 210px;
      height: 210px;
      border-radius: 999px;
      background: rgba(249, 250, 251, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: auto;
      margin-right: 2rem;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.28);
    }
    .hero-illust i {
      font-size: 4.2rem;
      color: #10b981;
    }
    .scroll-down-indicator {
      position: absolute;
      left: 50%;
      bottom: 10px;
      transform: translateX(-50%);
      width: 36px;
      height: 36px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.75);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #e5e7eb;
      font-size: 1rem;
      text-decoration: none;
      animation: bounce 1.4s infinite;
    }

    /* PRODUCT CARD */
    .product-card { border-radius: 12px; overflow: hidden; }
    .product-card .card-img-top { width: 100%; height: 220px; object-fit: cover; display: block; }
    .product-card .card-body { padding: 1rem; }
    .product-card .card-title { font-size: 1.05rem; }
    .product-card .badge { font-weight: 600; }
    .product-card img[loading="lazy"] { transition: transform .25s ease; }
    .product-card:hover img[loading="lazy"] { transform: scale(1.03); }

    /* ANIMATIONS */
    .animate-fadeIn { animation: fadeIn 0.6s ease-in; }
    .animate-slideInRight { animation: slideInRight 0.5s ease-out; }
    @keyframes fadeIn {
      from { opacity: 0; }
      to   { opacity: 1; }
    }
    @keyframes slideInRight {
      from { transform: translateX(30px); opacity: 0; }
      to   { transform: translateX(0);    opacity: 1; }
    }
    @keyframes bounce {
      0%, 100% { transform: translate(-50%, 0); }
      50%      { transform: translate(-50%, -8px); }
    }

    /* RESPONSIVE HERO */
    @media (max-width: 768px) {
      .hero-banner {
        border-radius: 0 0 18px 18px;
        min-height: 260px;
      }
      .hero-title {
        font-size: 1.7rem;
      }
      .hero-illust {
        display: none;
      }
    }
    @media (min-width: 1200px) {
      .product-card .card-img-top { height: 200px; }
    }
    @media (max-width: 576px) {
      .product-card .card-img-top { height: 160px; }
    }
    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(25, 135, 84, 0.4) !important;
    }

    /* ===== SORT BAR ===== */
    .sort-bar .btn-sort {
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      padding: 6px 14px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all .2s ease;
      color: #4b5563;
    }
    .sort-bar .btn-sort:hover {
      border-color: #22c55e;
      background: #f0fdf4;
      color: #16a34a;
      box-shadow: 0 4px 10px rgba(34, 197, 94, 0.25);
    }
    .sort-bar .btn-sort.active {
      background: #22c55e;
      color: #ffffff;
      border-color: #16a34a;
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.35);
    }

    /* ===== CATEGORY FILTER STYLE ===== */
    .section-category h5 {
      font-size: 1.1rem;
      letter-spacing: 0.5px;
    }
    .category-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
      gap: 16px;
    }
    .category-item {
      text-align: center;
      cursor: pointer;
      padding: 12px 8px;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      transition: all .25s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .category-icon {
      font-size: 2.4rem;
      margin-bottom: 8px;
      color: #22c55e;
      transition: all .25s ease;
    }
    .category-item span {
      font-size: 0.9rem;
      font-weight: 600;
      color: #374151;
    }
    .category-item:hover {
      background: #f0fdf4;
      border-color: #22c55e;
      transform: translateY(-3px);
      box-shadow: 0 8px 16px rgba(34, 197, 94, 0.25);
    }
    .category-item:hover .category-icon {
      color: #16a34a;
      transform: scale(1.1);
    }
    .category-item.active {
      background: #22c55e;
      border-color: #16a34a;
      box-shadow: 0 6px 16px rgba(34, 197, 94, 0.35);
    }
    .category-item.active .category-icon {
      color: #ffffff;
      transform: scale(1.1);
    }
    .category-item.active span {
      color: #ffffff;
    }

  //- ===== SCRIPT FILTER KATEGORI + SORT HARGA =====
  script.
    document.addEventListener("DOMContentLoaded", function () {
      const categories = document.querySelectorAll(".category-item");
      const productsRow = document.getElementById("productsRow");
      const sortButtons = document.querySelectorAll(".btn-sort");

      if (!productsRow) return;

      const products = Array.from(productsRow.querySelectorAll("[data-cat]"));

      if (!categories.length || !products.length) return;

      // simpan urutan awal
      products.forEach((p, idx) => {
        p.dataset.index = idx;
      });

      // ====== FILTER KATEGORI ======
      categories.forEach(cat => {
        cat.addEventListener("click", () => {
          const selected = cat.dataset.cat;
          const isActive = cat.classList.contains("active");

          // reset semua state kategori
          categories.forEach(c => c.classList.remove("active"));
          products.forEach(p => p.style.display = "");

          // klik lagi kategori aktif -> reset
          if (isActive) {
            return;
          }

          // set active
          cat.classList.add("active");

          // filter produk berdasarkan kategori
          products.forEach(p => {
            const pCat = (p.dataset.cat || "").trim();

            if (selected === "other") {
              // other = selain 3 kategori utama
              if (pCat === "Sayur" || pCat === "Daging" || pCat === "Sembako") {
                p.style.display = "none";
              }
            } else {
              if (pCat !== selected) {
                p.style.display = "none";
              }
            }
          });
        });
      });

      // ====== SORT HARGA ======
      sortButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          const sortType = btn.dataset.sort; // asc / desc
          const isActive = btn.classList.contains("active");

          // reset state tombol
          sortButtons.forEach(b => b.classList.remove("active"));

          if (isActive) {
            // klik lagi tombol aktif -> reset ke urutan awal
            const original = [...products].sort((a, b) => {
              return Number(a.dataset.index) - Number(b.dataset.index);
            });
            original.forEach(el => productsRow.appendChild(el));
            return;
          }

          btn.classList.add("active");

          const sorted = [...products].sort((a, b) => {
            const pa = parseFloat(a.dataset.price || "0");
            const pb = parseFloat(b.dataset.price || "0");
            return sortType === "asc" ? (pa - pb) : (pb - pa);
          });

          sorted.forEach(el => productsRow.appendChild(el));
        });
      });
    });
