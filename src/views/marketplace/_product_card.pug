//- src/views/marketplace/_product_card.pug
//- safe partial: jika product tidak ada, fallback ke p atau objek kosong
- var product = (typeof product !== 'undefined') ? product : ((typeof p !== 'undefined') ? p : {});
- var productDetailUrl = `/market/product/${(product && product.id) || ''}`;

//- Wrapper ini sekarang menjadi anchor <a> yang dapat diklik
a.product-card-wrapper.h-100(
  href=productDetailUrl 
  style="text-decoration: none; color: inherit;"
)
  .card.h-100.border.product-card(
    // Hapus cursor: pointer dan event onmouseover/onmouseout dari sini
    style="border-radius: 8px; overflow: hidden; transition: all 0.2s ease;" 
  )
    // image area
    .card-image-wrap.position-relative(style="overflow: hidden; background: #f5f5f5;")
      if product && product.image
        img.card-img-top(
          src=product.image 
          alt=(product.name||'Produk') 
          loading='lazy' 
          style="height:200px; object-fit:cover; width: 100%;"
        )
      else
        .bg-light.d-flex.align-items-center.justify-content-center(style="height:200px;")
          i.bi.bi-image.text-muted(style="font-size: 3rem;")

      // discount badge - top left (if applicable)
      //- You can add discount percentage here if available
      //- .position-absolute.top-0.start-0.m-2
      //-   span.badge.bg-danger(style="border-radius: 4px; font-weight: 600; font-size: 0.75rem;") 50%

      // stock badge - bottom left
      .position-absolute.bottom-0.start-0.m-2
        if product && product.stock && Number(product.stock) > 0
          span.badge(style="background: rgba(255, 255, 255, 0.95); color: #03ac0e; border-radius: 4px; font-weight: 600; font-size: 0.7rem; padding: 4px 8px;")
            i.bi.bi-check-circle-fill.me-1(style="font-size: 0.7rem;")
            | Tersedia
        else
          span.badge(style="background: rgba(255, 255, 255, 0.95); color: #dc3545; border-radius: 4px; font-weight: 600; font-size: 0.7rem; padding: 4px 8px;")
            | Stok Habis

      // Category badge (optional, at top)
      if product && product.category
        .position-absolute.top-0.end-0.m-2
          span.badge.bg-light.text-dark(style="font-size: 0.65rem; font-weight: 500; border-radius: 4px;")
            = product.category

    // body
    .card-body.p-3(style="background: white;")
      
      // product name
      .product-name.mb-2(style="min-height: 40px;")
        .text-dark.small(style="line-height:1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; font-size: 0.875rem;")
          = (product && product.name) || 'Produk'

      // price section
      .price-section.mb-2
        .fw-bold(style="font-size: 1.125rem; color: #212121;")
          | Rp#{Number((product && product.price) || 0).toLocaleString('id-ID')}
        if product && product.unit
          .text-muted(style="font-size: 0.75rem;")
            | per #{product.unit}

      // rating & sold
      .d-flex.align-items-center.gap-2.mb-2
        .d-flex.align-items-center
          i.bi.bi-star-fill(style="color: #ffc107; font-size: 0.75rem;")
          span.ms-1(style="font-size: 0.75rem; color: #6d6d6d;") 4.9
        .text-muted(style="font-size: 0.75rem;") | 
        .text-muted(style="font-size: 0.75rem;") #{Number((product && product.stock) || 0)} terjual

    // action button (on hover or always visible)
    .card-footer.bg-white.border-0.p-2(style="border-top: 1px solid #e5e5e5 !important;")
      if currentUser && currentUser.role === 'dapur'
        // jika belum lengkap -> arahkan ke halaman lengkapi profile
        if !(currentUser.phone && currentUser.address)
          a.btn.btn-sm.btn-warning.w-100(
            href="/dapur/profile/complete"
            onclick="event.stopPropagation()"
            title="Lengkapi data dapur (alamat & telepon)"
          )
            i.bi.bi-pencil-square.me-1
            | Lengkapi Data Dapur
        else
          // user sudah lengkap: tampilkan form tambah keranjang
          form.add-to-cart-form(action="/dapur/cart/add" method="post" onclick="event.stopPropagation()")
            input(type="hidden" name="product_id" value=(product && product.id))
            if typeof csrfToken !== 'undefined'
              input(type="hidden" name="_csrf" value=csrfToken)
            .d-flex.gap-2.align-items-center
              .input-group(style="max-width: 100px;")
                button.btn.btn-sm.btn-outline-secondary(
                  type="button"
                  onclick="event.stopPropagation(); let inp=this.parentElement.querySelector('input[name=qty]'); let v=parseInt(inp.value,10); if(isNaN(v)||v<=1)v=1; else v--; inp.value=v;"
                  style="border-radius: 4px 0 0 4px; padding: 4px 8px;"
                )
                  i.bi.bi-dash(style="font-size: 0.75rem;")

                input.form-control.form-control-sm.text-center(
                  type="number"
                  name="qty"
                  value="1"
                  min="1"
                  step="1"
                  onclick="event.stopPropagation()"
                  style="border-left: none; border-right: none; font-size: 0.75rem; padding: 4px;"
                )

                button.btn.btn-sm.btn-outline-secondary(
                  type="button"
                  onclick="event.stopPropagation(); let inp=this.parentElement.querySelector('input[name=qty]'); let v=parseInt(inp.value,10); if(isNaN(v)||v<1)v=1; else v++; inp.value=v;"
                  style="border-radius: 0 4px 4px 0; padding: 4px 8px;"
                )
                  i.bi.bi-plus(style="font-size: 0.75rem;")

              button.btn.btn-sm.btn-success.flex-fill(
                type="submit"
                disabled=!((product && product.stock) && Number(product.stock) > 0)
                onclick="event.stopPropagation()"
                style="border-radius: 4px; font-size: 0.75rem; font-weight: 600; padding: 6px 12px;"
              )
                i.bi.bi-cart-plus.me-1
                | Keranjang
      else
        a.btn.btn-sm.btn-outline-success.w-100(
          href=productDetailUrl
          style="border-radius: 4px; font-size: 0.75rem; font-weight: 600; text-decoration: none;"
        )
          i.bi.bi-eye.me-1
          | Lihat Detail
